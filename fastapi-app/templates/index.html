<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pë“¤ì„ ìœ„í•œ To-Do List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .todo-item {
      border: 1px solid #ddd;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .todo-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .todo-due-date {
      color: #666;
    }
    .near-deadline {
      background-color: #ffe6e6;
    }
    .overdue {
      background-color: #ffcccc;
    }
    .completed {
      text-decoration: line-through;
      opacity: 0.7;
    }
    .todo-actions {
      margin-top: 10px;
    }
    button {
      margin-right: 5px;
    }
    form {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    input, button {
      padding: 5px;
      margin: 5px;
    }
    .sort-controls {
      margin-bottom: 15px;
    }
    .todo-location {
      color: #0066cc;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    .dark-mode input,
    .dark-mode button {
      background-color: #1e1e1e;
      color: #f0f0f0;
      border: 1px solid #555;
    }
    .dark-mode .todo-item {
      border-color: #444;
      background-color: #1a1a1a;
    }
    .dark-mode .todo-location {
      color: #6699ff;
    }
    .dark-mode .near-deadline {
      background-color: #662222;
    }
    .dark-mode .overdue {
      background-color: #884444;
    }
  </style>
</head>
<body>
  <h1>Pë“¤ì„ ìœ„í•œ To-Do List</h1>
  <button id="toggle-dark-mode">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
  <input type="text" id="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." style="width:100%; padding: 8px; margin: 15px 0;">
  <div class="sort-controls">
    <button id="sort-by-date">ê¸°í•œì´ ê°€ê¹Œìš´ ìˆœìœ¼ë¡œ ì •ë ¬</button>
    <button id="sort-by-date-desc">ê¸°í•œì´ ë¨¼ ìˆœìœ¼ë¡œ ì •ë ¬</button>
    <button id="reset-sort">ì •ë ¬ ì´ˆê¸°í™”</button>
  </div>
  <form id="todo-form">
    <div>
      <label for="title">ì œëª©:</label>
      <input type="text" id="title" placeholder="ì œëª©" required>
    </div>
    <div>
      <label for="description">ì„¤ëª…:</label>
      <input type="text" id="description" placeholder="ì„¤ëª…" required>
    </div>
    <div>
      <label for="location">ì¥ì†Œ:</label>
      <input type="text" id="location" placeholder="ì¥ì†Œ">
    </div>
    <div>
      <label for="category">ì¹´í…Œê³ ë¦¬:</label>
      <input list="category-options" id="category" placeholder="ì¹´í…Œê³ ë¦¬">
      <datalist id="category-options"></datalist>
    </div>
    <div>
      <label for="due-date">ê¸°í•œ:</label>
      <input type="date" id="due-date" placeholder="ê¸°í•œ">
    </div>
    <button type="submit">í•  ì¼ ì¶”ê°€</button>
  </form>
  <div id="todo-list"></div>

  <script>
    let allTodos = [];

    async function fetchTodos(sortByDate = false, ascending = true) {
      const url = sortByDate 
        ? `/todos?sort_by_date=true&ascending=${ascending}` 
        : '/todos';
      const response = await fetch(url);
      const todos = await response.json();
      allTodos = todos;
      renderTodos(todos);
      updateCategoryOptions(todos);
    }

    function renderTodos(todos) {
      const todoList = document.getElementById('todo-list');
      todoList.innerHTML = '';
      todos.forEach(todo => {
        const todoItem = document.createElement('div');
        todoItem.className = 'todo-item';
        if (todo.completed) todoItem.classList.add('completed');
        if (todo.due_date) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const dueDate = new Date(todo.due_date);
          dueDate.setHours(0, 0, 0, 0);
          const timeDiff = dueDate.getTime() - today.getTime();
          const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
          if (dayDiff < 0 && !todo.completed) {
            todoItem.classList.add('overdue');
          } else if (dayDiff <= 3 && !todo.completed) {
            todoItem.classList.add('near-deadline');
          }
        }

        const todoHeader = document.createElement('div');
        todoHeader.className = 'todo-header';
        const titleEl = document.createElement('h3');
        titleEl.textContent = todo.title;
        const dueDateEl = document.createElement('div');
        dueDateEl.className = 'todo-due-date';
        dueDateEl.textContent = todo.due_date ? `ê¸°í•œ: ${new Date(todo.due_date).toLocaleDateString()}` : 'ê¸°í•œ ì—†ìŒ';
        todoHeader.appendChild(titleEl);
        todoHeader.appendChild(dueDateEl);

        const descriptionEl = document.createElement('p');
        descriptionEl.textContent = todo.description;

        const locationEl = document.createElement('p');
        locationEl.className = 'todo-location';
        locationEl.textContent = todo.location ? `ì¥ì†Œ: ${todo.location}` : 'ì¥ì†Œ ë¯¸ì§€ì •';

        const categoryEl = document.createElement('p');
        categoryEl.textContent = `ì¹´í…Œê³ ë¦¬: ${todo.category || 'ì—†ìŒ'}`;

        const statusEl = document.createElement('p');
        statusEl.textContent = `ìƒíƒœ: ${todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ì¤‘'}`;

        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'todo-actions';

        const completeButton = document.createElement('button');
        completeButton.textContent = todo.completed ? 'ì™„ë£Œ ì·¨ì†Œ' : 'ì™„ë£Œ ì²˜ë¦¬';
        completeButton.onclick = async () => {
          await fetch(`/todos/${todo.id}/complete`, { method: 'PUT' });
          fetchTodos();
        };

        const editButton = document.createElement('button');
        editButton.textContent = 'ìˆ˜ì •';
        editButton.onclick = () => {
          todoItem.innerHTML = '';
          const form = document.createElement('form');
          form.onsubmit = async (e) => {
            e.preventDefault();
            await fetch(`/todos/${todo.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: todo.id,
                title: form.elements.title.value,
                description: form.elements.description.value,
                location: form.elements.location.value || null,
                category: form.elements.category.value || null,
                due_date: form.elements.dueDate.value || null,
                completed: todo.completed
              })
            });
            fetchTodos(sortByDate, ascending);
          };
          const titleInput = document.createElement('div');
          titleInput.innerHTML = `<label for="edit-title-${todo.id}">ì œëª©:</label><input type="text" name="title" id="edit-title-${todo.id}" value="${todo.title}" required>`;
          const descInput = document.createElement('div');
          descInput.innerHTML = `<label for="edit-desc-${todo.id}">ì„¤ëª…:</label><input type="text" name="description" id="edit-desc-${todo.id}" value="${todo.description}" required>`;
          const locationInput = document.createElement('div');
          locationInput.innerHTML = `<label for="edit-location-${todo.id}">ì¥ì†Œ:</label><input type="text" name="location" id="edit-location-${todo.id}" value="${todo.location || ''}">`;
          const categoryInput = document.createElement('div');
          categoryInput.innerHTML = `<label for="edit-category-${todo.id}">ì¹´í…Œê³ ë¦¬:</label><input type="text" name="category" id="edit-category-${todo.id}" value="${todo.category || ''}">`;
          const dateInput = document.createElement('div');
          dateInput.innerHTML = `<label for="edit-date-${todo.id}">ê¸°í•œ:</label><input type="date" name="dueDate" id="edit-date-${todo.id}" value="${todo.due_date || ''}">`;
          const buttons = document.createElement('div');
          buttons.innerHTML = `<button type="submit">ì €ì¥</button><button type="button" id="cancel-edit-${todo.id}">ì·¨ì†Œ</button>`;
          buttons.querySelector(`#cancel-edit-${todo.id}`).onclick = () => fetchTodos(sortByDate, ascending);
          form.appendChild(titleInput);
          form.appendChild(descInput);
          form.appendChild(locationInput);
          form.appendChild(categoryInput);
          form.appendChild(dateInput);
          form.appendChild(buttons);
          todoItem.appendChild(form);
        };

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'ì‚­ì œ';
        deleteButton.onclick = async () => {
          if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await fetch(`/todos/${todo.id}`, { method: 'DELETE' });
            fetchTodos();
          }
        };

        actionsContainer.appendChild(completeButton);
        actionsContainer.appendChild(editButton);
        actionsContainer.appendChild(deleteButton);

        todoItem.appendChild(todoHeader);
        todoItem.appendChild(descriptionEl);
        todoItem.appendChild(locationEl);
        todoItem.appendChild(categoryEl);
        todoItem.appendChild(statusEl);
        todoItem.appendChild(actionsContainer);

        todoList.appendChild(todoItem);
      });
    }

    function updateCategoryOptions(todos) {
      const datalist = document.getElementById('category-options');
      const categories = [...new Set(todos.map(todo => todo.category).filter(Boolean))];
      datalist.innerHTML = '';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        datalist.appendChild(option);
      });
    }

    function updateDarkModeButtonText() {
      const isDark = document.body.classList.contains('dark-mode');
      document.getElementById('toggle-dark-mode').textContent = isDark ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }

    function filterTodos(keyword) {
      const lowerKeyword = keyword.toLowerCase();
      const filtered = allTodos.filter(todo =>
        todo.title.toLowerCase().includes(lowerKeyword) ||
        todo.description.toLowerCase().includes(lowerKeyword) ||
        (todo.location && todo.location.toLowerCase().includes(lowerKeyword)) ||
        (todo.category && todo.category.toLowerCase().includes(lowerKeyword))
      );
      renderTodos(filtered);
    }

    document.getElementById('todo-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const location = document.getElementById('location').value;
      const category = document.getElementById('category').value;
      const dueDate = document.getElementById('due-date').value || null;
      const response = await fetch('/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          id: Date.now(), 
          title, 
          description, 
          location,
          category,
          completed: false,
          due_date: dueDate
        })
      });
      if (response.ok) {
        document.getElementById('title').value = '';
        document.getElementById('description').value = '';
        document.getElementById('location').value = '';
        document.getElementById('category').value = '';
        document.getElementById('due-date').value = '';
        fetchTodos();
      }
    });

    document.getElementById('sort-by-date').addEventListener('click', () => fetchTodos(true, true));
    document.getElementById('sort-by-date-desc').addEventListener('click', () => fetchTodos(true, false));
    document.getElementById('reset-sort').addEventListener('click', () => fetchTodos(false));

    document.getElementById('search-input').addEventListener('input', (e) => {
      const keyword = e.target.value;
      filterTodos(keyword);
    });

    // ì´ˆê¸°í™”
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }
    updateDarkModeButtonText();

    document.getElementById('toggle-dark-mode').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      updateDarkModeButtonText();
    });

    fetchTodos();
  </script>
</body>
</html>
