<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pë“¤ì„ ìœ„í•œ To-Do List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .todo-item {
      border: 1px solid #ddd;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .todo-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .todo-due-date {
      color: #666;
    }
    .near-deadline {
      background-color: #ffe6e6;
    }
    .overdue {
      background-color: #ffcccc;
    }
    .completed {
      text-decoration: line-through;
      opacity: 0.7;
    }
    .todo-actions {
      margin-top: 10px;
    }
    button {
      margin-right: 5px;
      padding: 8px 12px;
      cursor: pointer;
    }
    form {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    input, button {
      padding: 5px;
      margin: 5px;
    }
    .sort-controls {
      margin-bottom: 15px;
    }
    .sort-controls button {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
    }
    .sort-controls button.active {
      background-color: #007bff;
      color: white;
    }
    .todo-location {
      color: #0066cc;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    .edit-form {
      border: 2px solid #007bff;
      padding: 15px;
      border-radius: 5px;
      background-color: #f8f9fa;
    }
    .edit-form div {
      margin-bottom: 10px;
    }
    .edit-form label {
      display: inline-block;
      width: 80px;
      font-weight: bold;
    }
    .edit-form input {
      width: 200px;
      padding: 5px;
    }
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    .dark-mode input,
    .dark-mode button {
      background-color: #1e1e1e;
      color: #f0f0f0;
      border: 1px solid #555;
    }
    .dark-mode .todo-item {
      border-color: #444;
      background-color: #1a1a1a;
    }
    .dark-mode .todo-location {
      color: #6699ff;
    }
    .dark-mode .near-deadline {
      background-color: #662222;
    }
    .dark-mode .overdue {
      background-color: #884444;
    }
    .dark-mode .edit-form {
      background-color: #2a2a2a;
      border-color: #007bff;
    }
  </style>
</head>
<body>
  <h1>Pë“¤ì„ ìœ„í•œ To-Do List</h1>
  <button id="toggle-dark-mode">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
  <input type="text" id="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." style="width:100%; padding: 8px; margin: 15px 0;">
  
  <div class="sort-controls">
    <button id="sort-by-date" data-sort="asc">ê¸°í•œì´ ê°€ê¹Œìš´ ìˆœìœ¼ë¡œ ì •ë ¬</button>
    <button id="sort-by-date-desc" data-sort="desc">ê¸°í•œì´ ë¨¼ ìˆœìœ¼ë¡œ ì •ë ¬</button>
    <button id="reset-sort" data-sort="none">ì •ë ¬ ì´ˆê¸°í™”</button>
  </div>
  
  <form id="todo-form">
    <div>
      <label for="title">ì œëª©:</label>
      <input type="text" id="title" placeholder="ì œëª©" required>
    </div>
    <div>
      <label for="description">ì„¤ëª…:</label>
      <input type="text" id="description" placeholder="ì„¤ëª…" required>
    </div>
    <div>
      <label for="location">ì¥ì†Œ:</label>
      <input type="text" id="location" placeholder="ì¥ì†Œ">
    </div>
    <div>
      <label for="category">ì¹´í…Œê³ ë¦¬:</label>
      <input list="category-options" id="category" placeholder="ì¹´í…Œê³ ë¦¬">
      <datalist id="category-options"></datalist>
    </div>
    <div>
      <label for="due-date">ê¸°í•œ:</label>
      <input type="date" id="due-date" placeholder="ê¸°í•œ">
    </div>
    <button type="submit">í•  ì¼ ì¶”ê°€</button>
  </form>
  
  <div id="todo-list"></div>

  <script>
    let allTodos = [];
    let currentSort = 'none'; // 'none', 'asc', 'desc'

    // ì •ë ¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateSortButtons() {
      document.querySelectorAll('.sort-controls button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const activeButton = document.querySelector(`[data-sort="${currentSort}"]`);
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }

    async function fetchTodos(sortByDate = false, ascending = true) {
      try {
        const url = sortByDate 
          ? `/todos?sort_by_date=true&ascending=${ascending}` 
          : '/todos';
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const todos = await response.json();
        allTodos = todos;
        renderTodos(todos);
        updateCategoryOptions(todos);
        updateSortButtons();
      } catch (error) {
        console.error('Error fetching todos:', error);
        alert('í•  ì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function renderTodos(todos) {
      const todoList = document.getElementById('todo-list');
      todoList.innerHTML = '';
      
      if (todos.length === 0) {
        todoList.innerHTML = '<p>ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      
      todos.forEach(todo => {
        const todoItem = document.createElement('div');
        todoItem.className = 'todo-item';
        if (todo.completed) todoItem.classList.add('completed');
        
        // ë‚ ì§œ ê³„ì‚° ë° ìŠ¤íƒ€ì¼ ì ìš©
        if (todo.due_date) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const dueDate = new Date(todo.due_date);
          dueDate.setHours(0, 0, 0, 0);
          const timeDiff = dueDate.getTime() - today.getTime();
          const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
          
          if (dayDiff < 0 && !todo.completed) {
            todoItem.classList.add('overdue');
          } else if (dayDiff <= 3 && !todo.completed) {
            todoItem.classList.add('near-deadline');
          }
        }

        const todoHeader = document.createElement('div');
        todoHeader.className = 'todo-header';
        const titleEl = document.createElement('h3');
        titleEl.textContent = todo.title;
        const dueDateEl = document.createElement('div');
        dueDateEl.className = 'todo-due-date';
        dueDateEl.textContent = todo.due_date ? `ê¸°í•œ: ${new Date(todo.due_date).toLocaleDateString()}` : 'ê¸°í•œ ì—†ìŒ';
        todoHeader.appendChild(titleEl);
        todoHeader.appendChild(dueDateEl);

        const descriptionEl = document.createElement('p');
        descriptionEl.textContent = todo.description;

        const locationEl = document.createElement('p');
        locationEl.className = 'todo-location';
        locationEl.textContent = todo.location ? `ì¥ì†Œ: ${todo.location}` : 'ì¥ì†Œ ë¯¸ì§€ì •';

        const categoryEl = document.createElement('p');
        categoryEl.textContent = `ì¹´í…Œê³ ë¦¬: ${todo.category || 'ì—†ìŒ'}`;

        const statusEl = document.createElement('p');
        statusEl.textContent = `ìƒíƒœ: ${todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ì¤‘'}`;

        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'todo-actions';

        const completeButton = document.createElement('button');
        completeButton.textContent = todo.completed ? 'ì™„ë£Œ ì·¨ì†Œ' : 'ì™„ë£Œ ì²˜ë¦¬';
        completeButton.onclick = async () => {
          try {
            const response = await fetch(`/todos/${todo.id}/complete`, { method: 'PUT' });
            if (!response.ok) throw new Error('ì™„ë£Œ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
            await refreshCurrentView();
          } catch (error) {
            console.error('Error toggling complete:', error);
            alert('ì™„ë£Œ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        };

        const editButton = document.createElement('button');
        editButton.textContent = 'ìˆ˜ì •';
        editButton.onclick = () => showEditForm(todo, todoItem);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'ì‚­ì œ';
        deleteButton.onclick = async () => {
          if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
              const response = await fetch(`/todos/${todo.id}`, { method: 'DELETE' });
              if (!response.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
              await refreshCurrentView();
            } catch (error) {
              console.error('Error deleting todo:', error);
              alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          }
        };

        actionsContainer.appendChild(completeButton);
        actionsContainer.appendChild(editButton);
        actionsContainer.appendChild(deleteButton);

        todoItem.appendChild(todoHeader);
        todoItem.appendChild(descriptionEl);
        todoItem.appendChild(locationEl);
        todoItem.appendChild(categoryEl);
        todoItem.appendChild(statusEl);
        todoItem.appendChild(actionsContainer);

        todoList.appendChild(todoItem);
      });
    }

    // í˜„ì¬ ì •ë ¬ ìƒíƒœì— ë”°ë¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    async function refreshCurrentView() {
      switch(currentSort) {
        case 'asc':
          await fetchTodos(true, true);
          break;
        case 'desc':
          await fetchTodos(true, false);
          break;
        default:
          await fetchTodos(false);
      }
    }

    // ìˆ˜ì • í¼ í‘œì‹œ
    function showEditForm(todo, todoItem) {
      todoItem.innerHTML = '';
      
      const form = document.createElement('form');
      form.className = 'edit-form';
      form.onsubmit = async (e) => {
        e.preventDefault();
        await updateTodo(todo.id, form);
      };

      form.innerHTML = `
        <h4>í•  ì¼ ìˆ˜ì •</h4>
        <div>
          <label>ì œëª©:</label>
          <input type="text" id="edit-title" value="${todo.title}" required>
        </div>
        <div>
          <label>ì„¤ëª…:</label>
          <input type="text" id="edit-description" value="${todo.description}" required>
        </div>
        <div>
          <label>ì¥ì†Œ:</label>
          <input type="text" id="edit-location" value="${todo.location || ''}">
        </div>
        <div>
          <label>ì¹´í…Œê³ ë¦¬:</label>
          <input type="text" id="edit-category" value="${todo.category || ''}">
        </div>
        <div>
          <label>ê¸°í•œ:</label>
          <input type="date" id="edit-due-date" value="${todo.due_date || ''}">
        </div>
        <div>
          <button type="submit">ì €ì¥</button>
          <button type="button" onclick="refreshCurrentView()">ì·¨ì†Œ</button>
        </div>
      `;
      
      todoItem.appendChild(form);
    }

    // í•  ì¼ ì—…ë°ì´íŠ¸
    async function updateTodo(todoId, form) {
      try {
        const updatedTodo = {
          id: todoId,
          title: form.querySelector('#edit-title').value,
          description: form.querySelector('#edit-description').value,
          location: form.querySelector('#edit-location').value || null,
          category: form.querySelector('#edit-category').value || null,
          due_date: form.querySelector('#edit-due-date').value || null,
          completed: allTodos.find(t => t.id === todoId)?.completed || false
        };

        const response = await fetch(`/todos/${todoId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedTodo)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        await refreshCurrentView();
      } catch (error) {
        console.error('Error updating todo:', error);
        alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function updateCategoryOptions(todos) {
      const datalist = document.getElementById('category-options');
      const categories = [...new Set(todos.map(todo => todo.category).filter(Boolean))];
      datalist.innerHTML = '';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        datalist.appendChild(option);
      });
    }

    function updateDarkModeButtonText() {
      const isDark = document.body.classList.contains('dark-mode');
      document.getElementById('toggle-dark-mode').textContent = isDark ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }

    function filterTodos(keyword) {
      const lowerKeyword = keyword.toLowerCase();
      const filtered = allTodos.filter(todo =>
        todo.title.toLowerCase().includes(lowerKeyword) ||
        todo.description.toLowerCase().includes(lowerKeyword) ||
        (todo.location && todo.location.toLowerCase().includes(lowerKeyword)) ||
        (todo.category && todo.category.toLowerCase().includes(lowerKeyword))
      );
      renderTodos(filtered);
    }

    // ìƒˆ í•  ì¼ ì¶”ê°€
    document.getElementById('todo-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      
      try {
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const location = document.getElementById('location').value;
        const category = document.getElementById('category').value;
        const dueDate = document.getElementById('due-date').value || null;
        
        const response = await fetch('/todos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            id: Date.now(), 
            title, 
            description, 
            location: location || null,
            category: category || null,
            completed: false,
            due_date: dueDate
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // í¼ ì´ˆê¸°í™”
        document.getElementById('title').value = '';
        document.getElementById('description').value = '';
        document.getElementById('location').value = '';
        document.getElementById('category').value = '';
        document.getElementById('due-date').value = '';
        
        await refreshCurrentView();
      } catch (error) {
        console.error('Error creating todo:', error);
        alert('í•  ì¼ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ì •ë ¬ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('sort-by-date').addEventListener('click', async () => {
      currentSort = 'asc';
      await fetchTodos(true, true);
    });

    document.getElementById('sort-by-date-desc').addEventListener('click', async () => {
      currentSort = 'desc';
      await fetchTodos(true, false);
    });

    document.getElementById('reset-sort').addEventListener('click', async () => {
      currentSort = 'none';
      await fetchTodos(false);
    });

    // ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById('search-input').addEventListener('input', (e) => {
      const keyword = e.target.value;
      filterTodos(keyword);
    });

    // ë‹¤í¬ëª¨ë“œ í† ê¸€
    document.getElementById('toggle-dark-mode').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      updateDarkModeButtonText();
    });

    // ì´ˆê¸°í™”
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }
    updateDarkModeButtonText();

    // ì•± ì‹œì‘
    fetchTodos();
  </script>
</body>
</html>